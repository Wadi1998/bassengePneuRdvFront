# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš€ GitHub Actions - CI/CD Deploy Frontend to VPS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# DÃ©ploiement automatique du frontend Angular sur VPS Hostinger
# DÃ©clenchÃ© Ã  chaque push sur la branche main ou staging
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ğŸš€ CI/CD Deploy Frontend to VPS

on:
  push:
    branches:
      - main
      - staging
      - master
  pull_request:
    branches:
      - main
      - staging
      - master
  workflow_dispatch:  # DÃ©clenchement manuel

env:
  NODE_VERSION: '20'
  DOCKER_IMAGE_NAME: garagepneu-frontend

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ§ª Job 1: Tests et Build
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test-and-build:
    name: ğŸ§ª Test & Build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“š Installation des dÃ©pendances
        run: npm ci --legacy-peer-deps

      - name: ğŸ” Linting
        run: npm run lint || true
        continue-on-error: true

      - name: ğŸ—ï¸ Build de production
        run: npm run build:prod

      - name: ğŸ“¤ Upload du build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-staging
          path: dist/garage-pneu/browser
          retention-days: 1

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸš€ Job 2: DÃ©ploiement sur VPS
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: ğŸš€ Deploy to VPS
    runs-on: ubuntu-latest
    needs: test-and-build

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Configuration SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“‚ CrÃ©ation du rÃ©pertoire sur le serveur
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            mkdir -p ~/garagepneu-frontend
          EOF

      - name: ğŸ“¤ Transfert des fichiers vers le serveur
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='dist' \
            --exclude='.angular' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:~/garagepneu-frontend/

      - name: ğŸ³ Build et dÃ©ploiement Docker
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd ~/garagepneu-frontend

            # CrÃ©er le rÃ©seau s'il n'existe pas
            docker network create garagepneu-network 2>/dev/null || true

            # ArrÃªter et supprimer l'ancien conteneur s'il existe
            docker stop garagepneu-frontend 2>/dev/null || true
            docker rm garagepneu-frontend 2>/dev/null || true

            # Supprimer l'ancienne image
            docker rmi garagepneu-frontend:latest 2>/dev/null || true

            # Builder la nouvelle image (prod)
            docker build -t garagepneu-frontend:latest --build-arg BUILD_CONFIGURATION=prod .

            # Lancer le conteneur
            docker run -d \
              --name garagepneu-frontend \
              --network garagepneu-network \
              -p 127.0.0.1:3000:80 \
              --restart unless-stopped \
              garagepneu-frontend:latest

            # VÃ©rifier le statut
            docker ps | grep garagepneu-frontend

            # Nettoyer les images non utilisÃ©es
            docker image prune -f
          EOF

      - name: âœ… VÃ©rification du dÃ©ploiement
        run: |
          echo "â³ Attente du dÃ©marrage du service..."
          sleep 10

          # VÃ©rifier santÃ© HTTP (interne)
          response_http=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VPS_HOST }}:3000/health || echo "000")

          # VÃ©rifier santÃ© HTTPS publique (optionnel si cert actif)
          response_https=$(curl -s -o /dev/null -w "%{http_code}" https://bassenge-pneus.com/health || echo "000")

          echo "HTTP interne (3000) => $response_http"
          echo "HTTPS public (bassenge-pneus.com) => $response_https"

          if [ "$response_http" = "200" ]; then
            echo "âœ… Frontend OK sur 127.0.0.1:3000"
          else
            echo "âš ï¸ Frontend ne rÃ©pond pas sur 3000 (HTTP $response_http)"
          fi

          if [ "$response_https" = "200" ]; then
            echo "âœ… HTTPS public OK: https://bassenge-pneus.com/health"
          else
            echo "â„¹ï¸ HTTPS public non OK (HTTP $response_https). Si le cert vient dâ€™Ãªtre demandÃ©, rÃ©essaie dans quelques minutes."
          fi

      - name: ğŸ§¹ Nettoyage SSH
        if: always()
        run: rm -f ~/.ssh/id_rsa
