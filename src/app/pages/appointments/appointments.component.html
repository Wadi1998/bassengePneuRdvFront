<section class="max-w-7xl mx-auto px-4 py-8 text-slate-100">
  <!-- Titre + badge date -->
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-3xl font-extrabold tracking-tight">{{ i18n.t('appointments.title') }}</h2>
    <span class="inline-flex items-center gap-2 text-sm px-4 py-2 rounded-full bg-white/5 border border-white/10">
      <svg class="h-4 w-4 text-sky-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      <span class="font-semibold capitalize">{{ dateObj | date:'EEEE' }}</span>
      <span class="text-slate-400">•</span>
      <span>{{ dateObj | date:'d MMMM yyyy' }}</span>
    </span>
  </div>

  <!-- Toolbar -->
  <div class="rounded-2xl bg-white/[0.04] border border-white/10 p-4 md:p-5 mb-3">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-3">

      <!-- Sélection client -->
      <div class="lg:col-span-3 relative">
        <button type="button" class="h-11 w-full px-3 rounded-xl bg-white/5 border border-white/10 text-left hover:bg-white/10 transition"
                (click)="showClientPicker = !showClientPicker">
          <ng-container *ngIf="!selectedClient; else clientSelected">
            {{ i18n.t('appointments.selectClientPlaceholder') }}
          </ng-container>
          <ng-template #clientSelected>
            <div class="flex items-center justify-between">
              <span class="truncate">{{ fullName(selectedClient) }}</span>
              <span class="text-xs text-slate-300 ml-2 truncate">{{ selectedClient?.phone }}</span>
            </div>
          </ng-template>
        </button>

        <!-- Popover clients -->
        <div *ngIf="showClientPicker" class="absolute z-20 mt-2 w-full rounded-xl border border-white/10 bg-slate-900/95 backdrop-blur p-2 shadow-xl">
          <div class="relative mb-2">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 opacity-70">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/>
              </svg>
            </span>
            <input class="h-10 w-full pl-9 pr-3 rounded-lg bg-white/5 border border-white/10 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-white/20"
                   placeholder="{{ i18n.t('appointments.searchClientPlaceholder') }}"
                   [(ngModel)]="clientSearch" (ngModelChange)="onClientSearchChange()" />
          </div>

          <div class="max-h-72 overflow-auto space-y-1 pr-1">
            <button *ngFor="let c of filteredClients" type="button" (click)="pickClient(c)"
                    class="w-full text-left rounded-lg px-3 py-2 hover:bg-white/10 transition flex items-center gap-3">
              <div class="h-8 w-8 rounded-full bg-white/10 flex items-center justify-center font-semibold">
                {{ initialsOf(c) | uppercase }}
              </div>
              <div class="min-w-0">
                <div class="font-medium truncate">{{ c.firstName }} {{ c.name }}</div>
                <div class="text-xs text-slate-300 truncate">
                  {{ c.phone }}
                </div>
              </div>
            </button>
          </div>

          <!-- Lien vers création de client -->
          <div class="border-t border-white/10 mt-2 pt-2">
            <a routerLink="/clients" class="w-full text-left rounded-lg px-3 py-2 hover:bg-emerald-500/10 transition flex items-center gap-3 text-emerald-400">
              <div class="h-8 w-8 rounded-full bg-emerald-500/20 flex items-center justify-center">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 5v14m-7-7h14"/>
                </svg>
              </div>
              <span class="text-sm font-medium">{{ i18n.t('appointments.newClient') }}</span>
            </a>
          </div>
        </div>
      </div>

      <!-- Date -->
      <div class="lg:col-span-3">
        <div class="relative">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 opacity-70">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/>
            </svg>
          </span>
          <input type="date" class="h-11 w-full pl-9 pr-3 rounded-xl bg-white/5 border border-white/10 focus:outline-none focus:ring-2 focus:ring-white/20"
                 [ngModel]="date" (ngModelChange)="setDate($event)" />
        </div>
      </div>

      <!-- Durée -->
      <div class="lg:col-span-3">
        <div class="flex h-11 items-center rounded-xl bg-white/5 border border-white/10 p-1 gap-1">
          <button *ngFor="let d of durations" type="button" (click)="setDuration(d)"
                  class="px-3 h-9 rounded-lg text-sm transition"
                  [ngClass]="duration === d ? 'bg-white/10 ring-1 ring-white/20' : 'hover:bg-white/10'">
            {{ d }} {{ i18n.t('toolbar.minutesShort') }}
          </button>
        </div>
      </div>

      <!-- Type de service (OBLIGATOIRE) -->
      <div class="lg:col-span-6">
        <div class="relative mb-2">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 opacity-70">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 7h18M5 7l2 12h10l2-12M10 11h4"/>
            </svg>
          </span>
          <input
            class="h-11 w-full pl-9 pr-3 rounded-xl border placeholder:text-slate-400 focus:outline-none focus:ring-2 bg-white/5"
            [class.border-white/10]="serviceValid"
            [class.border-rose-400/40]="!serviceValid && showServiceError"
            [class.focus:ring-white/20]="serviceValid"
            [class.focus:ring-rose-400/30]="!serviceValid"
            placeholder="{{ i18n.t('appointments.servicePlaceholder') }}"
            [(ngModel)]="serviceType"
            (ngModelChange)="showServiceError = false"
          />
          <div *ngIf="!serviceValid && showServiceError" class="mt-1 text-xs text-rose-300">
            {{ i18n.t('appointments.serviceRequired') }}
          </div>
        </div>
        <!-- Services rapides -->
        <div class="flex flex-wrap gap-1.5">
          <button type="button" (click)="serviceType = i18n.t('appointments.services.changementPneus')"
                  class="text-xs px-2.5 py-1 rounded-lg border transition"
                  [ngClass]="serviceType === i18n.t('appointments.services.changementPneus') ? 'bg-sky-500/20 border-sky-500/40 text-sky-300' : 'bg-white/5 border-white/10 hover:bg-white/10 text-slate-300'">
            🛞 {{ i18n.t('appointments.services.changementPneus') }}
          </button>
          <button type="button" (click)="serviceType = i18n.t('appointments.services.equilibrage')"
                  class="text-xs px-2.5 py-1 rounded-lg border transition"
                  [ngClass]="serviceType === i18n.t('appointments.services.equilibrage') ? 'bg-sky-500/20 border-sky-500/40 text-sky-300' : 'bg-white/5 border-white/10 hover:bg-white/10 text-slate-300'">
            ⚖️ {{ i18n.t('appointments.services.equilibrage') }}
          </button>
          <button type="button" (click)="serviceType = i18n.t('appointments.services.parallelisme')"
                  class="text-xs px-2.5 py-1 rounded-lg border transition"
                  [ngClass]="serviceType === i18n.t('appointments.services.parallelisme') ? 'bg-sky-500/20 border-sky-500/40 text-sky-300' : 'bg-white/5 border-white/10 hover:bg-white/10 text-slate-300'">
            📐 {{ i18n.t('appointments.services.parallelisme') }}
          </button>
          <button type="button" (click)="serviceType = i18n.t('appointments.services.reparation')"
                  class="text-xs px-2.5 py-1 rounded-lg border transition"
                  [ngClass]="serviceType === i18n.t('appointments.services.reparation') ? 'bg-sky-500/20 border-sky-500/40 text-sky-300' : 'bg-white/5 border-white/10 hover:bg-white/10 text-slate-300'">
            🔧 {{ i18n.t('appointments.services.reparation') }}
          </button>
          <button type="button" (click)="serviceType = i18n.t('appointments.services.permutation')"
                  class="text-xs px-2.5 py-1 rounded-lg border transition"
                  [ngClass]="serviceType === i18n.t('appointments.services.permutation') ? 'bg-sky-500/20 border-sky-500/40 text-sky-300' : 'bg-white/5 border-white/10 hover:bg-white/10 text-slate-300'">
            🔄 {{ i18n.t('appointments.services.permutation') }}
          </button>
          <button type="button" (click)="serviceType = i18n.t('appointments.services.controle')"
                  class="text-xs px-2.5 py-1 rounded-lg border transition"
                  [ngClass]="serviceType === i18n.t('appointments.services.controle') ? 'bg-sky-500/20 border-sky-500/40 text-sky-300' : 'bg-white/5 border-white/10 hover:bg-white/10 text-slate-300'">
            ✅ {{ i18n.t('appointments.services.controle') }}
          </button>
        </div>
      </div>


      <!-- Navigation jours -->
      <div class="lg:col-span-3 flex gap-2">
        <button class="h-11 px-4 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition" (click)="prevDay()">‹ {{ i18n.t('appointments.prevDay') }}</button>
        <button class="h-11 px-4 rounded-xl bg-sky-500/20 border border-sky-500/30 text-sky-300 hover:bg-sky-500/30 transition" (click)="goToday()">{{ i18n.t('appointments.today') }}</button>
        <button class="h-11 px-4 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition" (click)="nextDay()">{{ i18n.t('appointments.nextDay') }} ›</button>
      </div>

    </div>
  </div>

  <!-- Fiche client sélectionné -->
  <div *ngIf="selectedClient" class="rounded-xl bg-white/[0.04] border border-white/10 p-4 mb-6">
    <div class="flex flex-wrap items-center gap-3">
      <div class="h-9 w-9 rounded-full bg-white/10 flex items-center justify-center font-semibold">
        {{ initialsOf(selectedClient) | uppercase }}
      </div>
      <div class="min-w-0">
        <div class="font-semibold truncate">{{ fullName(selectedClient) }}</div>
        <div class="text-sm text-slate-300 truncate">
          <a class="hover:underline" [href]="'tel:' + selectedClient.phone">{{ selectedClient.phone }}</a>
        </div>
      </div>

      <!-- Sélection voiture -->
      <div class="relative ml-4" *ngIf="clientCars.length > 0">
        <button type="button"
                class="h-9 px-4 rounded-lg border text-sm flex items-center gap-2 transition"
                [ngClass]="selectedCar
                  ? 'bg-emerald-500/10 border-emerald-500/30 text-emerald-300 hover:bg-emerald-500/20'
                  : 'bg-amber-500/10 border-amber-500/30 text-amber-300 hover:bg-amber-500/20'"
                (click)="showCarPicker = !showCarPicker">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 17h14v-5H5zm0 0v2h14v-2M7 12l2-5h6l2 5M7 17v2M17 17v2"/>
          </svg>
          <span *ngIf="selectedCar">{{ formatCarInfo(selectedCar) }}</span>
          <span *ngIf="!selectedCar">{{ i18n.t('appointments.selectCar') }}</span>
          <svg class="h-3 w-3 opacity-60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 9l6 6 6-6"/>
          </svg>
        </button>

        <!-- Dropdown voitures -->
        <div *ngIf="showCarPicker" class="absolute z-20 mt-2 left-0 min-w-64 rounded-xl border border-white/10 bg-slate-900/95 backdrop-blur p-2 shadow-xl">
          <div class="text-xs text-slate-400 px-3 py-1 mb-1">{{ i18n.t('appointments.clientCars') }}</div>
          <div class="max-h-48 overflow-auto space-y-1">
            <button *ngFor="let car of clientCars" type="button" (click)="pickCar(car)"
                    class="w-full text-left rounded-lg px-3 py-2 hover:bg-white/10 transition flex items-center gap-3"
                    [ngClass]="{'bg-emerald-500/10 ring-1 ring-emerald-500/30': selectedCar?.id === car.id}">
              <div class="h-8 w-8 rounded-lg bg-white/10 flex items-center justify-center">
                <svg class="h-4 w-4 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M5 17h14v-5H5zm0 0v2h14v-2M7 12l2-5h6l2 5M7 17v2M17 17v2"/>
                </svg>
              </div>
              <div class="min-w-0 flex-1">
                <div class="font-medium truncate">{{ car.brand }} {{ car.model }}</div>
                <div class="text-xs text-slate-400 truncate" *ngIf="car.licensePlate || car.year">
                  <span *ngIf="car.licensePlate">{{ car.licensePlate }}</span>
                  <span *ngIf="car.licensePlate && car.year"> · </span>
                  <span *ngIf="car.year">{{ car.year }}</span>
                </div>
              </div>
              <svg *ngIf="selectedCar?.id === car.id" class="h-4 w-4 text-emerald-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 6L9 17l-5-5"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Loading voitures -->
      <div *ngIf="isLoadingCars" class="ml-4 flex items-center gap-2 text-sm text-slate-400">
        <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        {{ i18n.t('common.loading') }}
      </div>

      <!-- Pas de voiture -->
      <div *ngIf="!isLoadingCars && clientCars.length === 0" class="ml-4 text-xs text-slate-400 bg-slate-700/30 px-3 py-1.5 rounded-lg">
        {{ i18n.t('appointments.noCars') }}
      </div>

      <button class="ml-auto h-9 px-3 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 text-sm" (click)="clearClient()">{{ i18n.t('appointments.changeClient') }}</button>
    </div>
  </div>

  <!-- Toujours deux colonnes A & B -->
  <div class="grid md:grid-cols-2 gap-5">
    <!-- A -->
    <div class="rounded-2xl bg-white/[0.04] border border-white/10 p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">{{ i18n.t('dashboard.slotsA') }}</h3>
        <span class="text-xs text-slate-300">{{ i18n.t('appointments.slotNote', { duration: duration }) }}</span>
      </div>
      <ng-container *ngIf="showSlots">
        <app-slot-picker
          [date]="date"
          [duration]="duration"
          [bay]="'A'"
          [items]="items"
          [serviceType]="serviceType"
          [canBook]="canBook"
          [needService]="!serviceValid"
          [needClient]="!clientValid"
          [isLoading]="isLoading"
          (pick)="onPickA($event)"
          (blocked)="onBlocked($event)"
          (deleteAppointment)="onDeleteAppointment($event)"
        ></app-slot-picker>
      </ng-container>
    </div>

    <!-- B -->
    <div class="rounded-2xl bg-white/[0.04] border border-white/10 p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">{{ i18n.t('dashboard.slotsB') }}</h3>
        <span class="text-xs text-slate-300">{{ i18n.t('appointments.slotNote', { duration: duration }) }}</span>
      </div>
      <ng-container *ngIf="showSlots">
        <app-slot-picker
          [date]="date"
          [duration]="duration"
          [bay]="'B'"
          [items]="items"
          [serviceType]="serviceType"
          [canBook]="canBook"
          [needService]="!serviceValid"
          [needClient]="!clientValid"
          [isLoading]="isLoading"
          (pick)="onPickB($event)"
          (blocked)="onBlocked($event)"
          (deleteAppointment)="onDeleteAppointment($event)"
        ></app-slot-picker>
      </ng-container>
    </div>
  </div>

  <!-- Modal de confirmation -->
  <app-confirm-dialog
    [isOpen]="isConfirmOpen"
    [data]="confirmData"
    (confirmed)="onConfirmDelete()"
    (cancelled)="onCancelDelete()"
  ></app-confirm-dialog>
</section>
