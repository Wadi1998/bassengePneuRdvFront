<section class="max-w-7xl mx-auto px-4 py-8 text-slate-100">

  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-3xl font-extrabold tracking-tight">{{ i18n.t('clients.title') }}</h2>
      <p class="text-sm text-slate-300 mt-1">
        {{ i18n.t('clients.description') }}
      </p>
    </div>
    <span class="badge-count">
      <!-- svg -->
      {{ i18n.t('clients.clientCount', { count: totalClient }) }}
    </span>
  </div>

  <!-- Formulaire + recherche -->
  <div class="card-dark p-6 md:p-7 mb-8">
    <!-- Formulaire -->
    <form
      [formGroup]="form"
      (ngSubmit)="add()"
      class="grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-x-6 md:gap-y-4 xl:gap-x-8 items-start
             xl:[grid-template-columns:repeat(14,minmax(0,1fr))]"
    >

      <!-- Prénom -->
      <div class="md:col-span-6 xl:col-span-3">
        <div class="field">
          <span class="field-icon text-sky-400" aria-hidden="true">
            <!-- user icon -->
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M4 20c0-3.3137 2.6863-6 6-6h4c3.3137 0 6 2.6863 6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          <input #firstNameInput formControlName="firstName" placeholder="{{ i18n.t('clients.firstnamePlaceholder') }}" class="field-input" />
        </div>
        <div class="text-xs text-red-400 mt-1" *ngIf="form.get('firstName')?.touched && form.get('firstName')?.invalid">
          {{ i18n.t('clients.firstNameRequired') }}
        </div>
      </div>

      <!-- Nom -->
      <div class="md:col-span-6 xl:col-span-3">
        <div class="field">
          <span class="field-icon text-indigo-400" aria-hidden="true">
            <!-- id icon -->
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.5"/>
              <path d="M8 11h8M8 15h5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="8" r="1" fill="currentColor"/>
            </svg>
          </span>
          <input formControlName="name" placeholder="{{ i18n.t('clients.namePlaceholder') }}" class="field-input" />
        </div>
        <div class="text-xs text-red-400 mt-1" *ngIf="form.get('name')?.touched && form.get('name')?.invalid">
          {{ i18n.t('clients.nameRequired') }}
        </div>
      </div>

      <!-- Téléphone -->
      <div class="md:col-span-6 xl:col-span-3">
        <div class="field">
          <span class="field-icon text-emerald-400" aria-hidden="true">
            <!-- phone icon -->
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.86 19.86 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.86 19.86 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.12 1.05.37 2.07.73 3.03a2 2 0 0 1-.45 2.11L8.09 10.91a14.1 14.1 0 0 0 6 6l1.05-1.05a2 2 0 0 1 2.11-.45c.96.36 1.98.61 3.03.73A2 2 0 0 1 22 16.92z" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          <input formControlName="phone" inputmode="tel" placeholder="{{ i18n.t('clients.phonePlaceholder') }}" class="field-input" />
        </div>
        <div class="text-xs text-red-400 mt-1" *ngIf="form.get('phone')?.touched && form.get('phone')?.hasError('bePhone')">
          {{ i18n.t('clients.phoneInvalid') }}
        </div>
      </div>

      <!-- Véhicle et Plaque alignés avec les autres champs -->
      <div class="md:col-span-6 xl:col-span-3">
        <!-- Véhicle -->
        <div class="field">
          <span class="field-icon text-amber-400" aria-hidden="true">
            <!-- car icon -->
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 13l1.5-4.5A2 2 0 0 1 6.4 7h11.2a2 2 0 0 1 1.9 1.5L21 13" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M5 19a1 1 0 1 0 0-2 1 1 0 0 0 0 2zM19 19a1 1 0 1 0 0-2 1 1 0 0 0 0 2z" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          <input formControlName="vehicle" placeholder="{{ i18n.t('clients.vehiclePlaceholder') }}" class="field-input" />
        </div>
        <div class="text-xs text-red-400 mt-1" *ngIf="form.get('vehicle')?.touched && form.get('vehicle')?.invalid">
          {{ i18n.t('clients.vehicleRequired') }}
        </div>
      </div>

      <div class="md:col-span-6 xl:col-span-3">
        <!-- Plaque -->
        <div class="field">
          <span class="field-icon text-violet-400" aria-hidden="true">
            <!-- plate / tag icon -->
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="2" y="6" width="20" height="12" rx="2" stroke="currentColor" stroke-width="1.3"/>
              <path d="M7 12h10" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
            </svg>
          </span>
          <input formControlName="plate" placeholder="{{ i18n.t('clients.platePlaceholder') }}" class="field-input" />
        </div>
        <div class="text-xs text-red-400 mt-1" *ngIf="form.get('plate')?.touched && form.get('plate')?.invalid">
          {{ i18n.t('clients.plateRequired') }}
        </div>
      </div>

      <!-- Adresse e-mail -->
      <div class="md:col-span-6 xl:col-span-3">
        <div class="field">
          <span class="field-icon text-sky-400" aria-hidden="true">
            <!-- mail icon -->
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 8l9 6 9-6" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M21 19H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h18a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          <input formControlName="email" type="email" placeholder="{{ i18n.t('clients.emailPlaceholder') }}" class="field-input" />
        </div>
        <div class="text-xs text-red-400 mt-1" *ngIf="form.get('email')?.touched && form.get('email')?.invalid">
          {{ i18n.t('clients.emailInvalid') || i18n.t('clients.emailPlaceholder') }}
        </div>
      </div>

      <!-- Bouton Ajouter déplacé en bas à gauche -->
      <div class="md:col-span-12 flex justify-start mt-4">
        <button
          type="submit"
          class="btn-cta h-11 w-full md:w-auto justify-center min-w-[150px]"
          [disabled]="form.invalid"
        >
          <span>{{ i18n.t('actions.addClientIcon') }}</span><span>{{ i18n.t('clients.addButton') }}</span>
        </button>
      </div>
    </form>
  </div>

  <!-- Barre de recherche déplacée en dessous du cadre avec un espacement supplémentaire -->
  <div class="field mt-8 mb-8">
    <span class="field-icon text-slate-400" aria-hidden="true">
      <!-- search icon -->
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.3"/>
        <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
      </svg>
    </span>
    <input
      [formControl]="search"
      placeholder="{{ i18n.t('clients.searchPlaceholder') || 'Rechercher (nom, prénom, téléphone, véhicule)' }}"
      class="field-input-ghost"
    />
  </div>

  <!-- Liste des clients -->
  <div *ngIf="filtered.length; else empty" class="bg-white/5 border border-white/10 rounded-2xl divide-y divide-white/10">
    <div *ngFor="let c of filtered; trackBy: trackById"
         class="px-4 md:px-5 py-4 flex items-center justify-between hover:bg-white/[.04] transition">
      <div class="flex items-center gap-3 min-w-0">
        <div class="h-10 w-10 rounded-full bg-brand-red flex items-center justify-center font-bold text-white">
          {{ initials(c) | uppercase }}
        </div>
        <div class="min-w-0">
          <div class="font-semibold truncate">{{ c.firstName }} {{ c.name }}</div>
          <div class="text-sm text-slate-300 truncate">
            <a class="hover:underline" [href]="'tel:' + c.phone">{{ phoneDisplay(c.phone) }}</a>
            <span *ngIf="c.vehicle"> • {{ c.vehicle }}</span>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-2 shrink-0">
        <button class="btn-warning-outline" (click)="openEditPopup(c)">
          <!-- pencil icon -->
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M3 21v-3.75L14.81 5.44a2.4 2.4 0 0 1 3.39 0l.36.36a2.4 2.4 0 0 1 0 3.39L6.75 21H3z" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          {{ i18n.t('clients.editButton') }}
        </button>
        <button class="btn-danger-outline" (click)="remove(c.id)">
          <!-- trash icon -->
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M3 6h18" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
            <path d="M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
          </svg>
          {{ i18n.t('clients.removeButton') }}
        </button>
      </div>
    </div>
  </div>

  <!-- Popup de modification améliorée -->
  <div *ngIf="isEditPopupOpen" class="fixed inset-0 z-50 flex items-center justify-center">
    <!-- Overlay cliquable -->
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" (click)="closeEditPopup()" aria-hidden="true"></div>

    <!-- Dialog -->
    <div role="dialog" aria-modal="true" aria-labelledby="edit-client-title" tabindex="-1" class="relative w-full max-w-2xl mx-4">
      <div class="card-dark p-6 rounded-2xl shadow-lg">
        <div class="flex items-start justify-between gap-4 mb-4">
          <h3 id="edit-client-title" class="text-lg font-semibold">{{ i18n.t('clients.editButton') }}</h3>
          <button type="button" (click)="closeEditPopup()" class="btn-secondary" aria-label="{{ i18n.t('clients.cancel') }}">
            <!-- close icon -->
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>

        <form [formGroup]="editForm" (ngSubmit)="updateClient()" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="edit-firstName" class="block text-sm font-medium text-slate-300 mb-1">{{ i18n.t('clients.firstnamePlaceholder') }}</label>
            <input id="edit-firstName" formControlName="firstName" class="field-input-compact" />
          </div>

          <div>
            <label for="edit-name" class="block text-sm font-medium text-slate-300 mb-1">{{ i18n.t('clients.namePlaceholder') }}</label>
            <input id="edit-name" formControlName="name" class="field-input-compact" />
          </div>

          <div>
            <label for="edit-phone" class="block text-sm font-medium text-slate-300 mb-1">{{ i18n.t('clients.phonePlaceholder') }}</label>
            <input id="edit-phone" formControlName="phone" class="field-input-compact" />
          </div>

          <div>
            <label for="edit-vehicle" class="block text-sm font-medium text-slate-300 mb-1">{{ i18n.t('clients.vehiclePlaceholder') }}</label>
            <input id="edit-vehicle" formControlName="vehicle" class="field-input-compact" />
          </div>

          <div>
            <label for="edit-plate" class="block text-sm font-medium text-slate-300 mb-1">{{ i18n.t('clients.platePlaceholder') }}</label>
            <input id="edit-plate" formControlName="plate" class="field-input-compact" />
          </div>

          <div>
            <label for="edit-email" class="block text-sm font-medium text-slate-300 mb-1">{{ i18n.t('clients.emailPlaceholder') }}</label>
            <input id="edit-email" formControlName="email" type="email" class="field-input-compact" />
          </div>

          <div class="col-span-full flex justify-end gap-2 mt-2">
            <button type="submit" class="btn-cta">{{ i18n.t('clients.save') }}</button>
            <button type="button" (click)="closeEditPopup()" class="btn-cta">{{ i18n.t('clients.cancel') }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div *ngIf="totalClient > pageSize" class="flex justify-center items-center gap-4 py-6">
    <button class="btn-cta px-3" [disabled]="page === 1" (click)="prevPage()">{{ i18n.t('clients.paginationPrev') }}</button>
    <span class="text-sm text-slate-300">
      {{ i18n.t('clients.pageOf', { page: page, total: totalPages }) }}
      <span class="mx-2">•</span>
      {{ i18n.t('clients.clientCount', { count: totalClient }) }}
    </span>
    <button class="btn-cta px-3" [disabled]="page === totalPages" (click)="nextPage()">{{ i18n.t('clients.paginationNext') }}</button>
  </div>

  <!-- Empty state -->
  <ng-template #empty>
    <div class="card-dark p-8 text-center">
      <div class="text-4xl mb-2">🧑‍🔧</div>
      <h3 class="text-lg font-semibold">{{ i18n.t('clients.noClientTitle') }}</h3>
      <p class="text-slate-300 text-sm mt-1">
        {{ i18n.t('clients.noClientMessage') }}
      </p>
      <button class="btn-cta mt-4" (click)="focusFirstInput()">
        <span>{{ i18n.t('actions.addClientIcon') }}</span><span>{{ i18n.t('clients.newClient') }}</span>
      </button>
    </div>
  </ng-template>

</section>
